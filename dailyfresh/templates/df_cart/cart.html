{% extends 'base.html' %}

{% block head %}
<script type="text/javascript">


    $(function() {
        total()

        //全选、全消
        // 使除了全选外的复选框状态与其一致
        $('#check_all').click(function() {
            var state = $(this).prop('checked')
            $('.checkgoods').prop('checked', state)
            total()
        })


        // Change事件触发有两个必要条件：值改变、失去焦点。所以当使用JQ改变值时，控件没有失去焦点，所以不会触发。
        // 目前验证有效的解决办法，只能是手动触发change事件
        // 单个勾选开关
        $('.checkgoods').click(function() {
            //总的checkbox的个数
            var len = $('.checkgoods').length;
            //已选中的checkbox的个数
            var checkedLen = $(".checkgoods:checked").length;
            if (len == checkedLen) {
                $('#check_all').prop('checked', true);
            } else {
                $('#check_all').prop('checked', false);
            }
            total()
        })


        // 数量加
        $('.add').click(function() {
            var num = $(this).prev()
            num.val(parseFloat(num.val()) + 1).blur()
        })

        // 数量减
        $('.minus').click(function() {
            num = $(this).next()
            num.val(parseFloat(num.val()) - 1).blur()

        })


        //手动修改数量
        $('.num_show').blur(function() {
            count = $(this).val()
            if (count <= 0) {
                alert('数量不能小于1');
                $(this).val(1);
                return
            } else if (count > 100) {
                alert('数量不能大于100');
                $(this).val(99);
                return
            }
            cartid = $(this).parents('.cart_list_td').attr('id');
            $.get('edit' + cartid + '_' + count +'/', function(data) {
                //修改成功
                if (data.ok == 0) {
                    total()
                }
                //修改失败(故障啥的),显示原来的数量
                else {
                    $(this).val(data.ok)
                }
            })
        })
    });


    // 计算小计和总计
    function total() {
        var totalprices = 0
        var totalcount = 0
        var totalcount1 = 0
        var cartcount = 0
        $('.checkgoods').each(function() {
            // 获取单价
            var price = $(this).parents().siblings('.col05').text();
            // 获取数量
            var count = $(this).parent().siblings('.col06').find('input').val()
            //计算小计
            var sumtotal = parseInt(count) * parseFloat(price);
            //显示小计
            $(this).parent().siblings('.col07').text(sumtotal.toFixed(2) + '元');
            if (this.checked == true) {
                totalprices += parseFloat(sumtotal)
                totalcount += 1
            }
            cartcount += parseInt(count)
            totalcount1 += 1
        })
        //显示总计
        $('#total').text(totalprices.toFixed(2) + '元')
        $('#totalcount').text(totalcount)
        $('#totalcount1').text(totalcount1)
        $('#cartcount').text(cartcount)


    }



    /* 删除*/
   function cart_del(cart_id){
        del=confirm('确定要删除吗？');
        if(del){
            $.get('delete'+cart_id+'/',function(data){
                if (data.ok ==1 ){
                    $('.cart_list_td').remove('#'+cart_id);
                    // data.cartcount > 0 ? $('#cartcount').text(data.cartcount) : $('#cartcount').text(0);
                    total()
                }
            });
        }
   }




</script>
{% endblock head %}



    {% block body %}
    <!-- <div class="total_count">全部商品<em id ="cartcount">{{request.session.cartcount|default:'0'}}</em>件</div> -->
    <div class="total_count">全部商品<em id ="totalcount1"></em>件， 总数量:<em id = "cartcount"></em></div>
    <ul class="cart_list_th clearfix">
        <li class="col01">商品名称</li>
        <li class="col02">商品单位</li>
        <li class="col03">商品价格</li>
        <li class="col04">数量</li>
        <li class="col05">小计</li>
        <li class="col06">操作</li>
    </ul>

    <form action="/order/" method="get">
        {% for cart in carts %}
        <ul class="cart_list_td clearfix" id="{{ cart.id }}">
            <li class="col01"><input type="checkbox" name="orderid" value="{{cart.id}}" class="checkgoods" )></li>
            <li class="col02"><a href="/{{ cart.goods.id }}"><img src="/static/{{cart.goods.gpic}}"></a></li>
            <li class="col03"><a href="/{{ cart.goods.id }}">{{cart.goods.gtitle}}</a><br><em>{{cart.goods.gprice}}元/{{cart.goods.gunit}}</em></li>
            <li class="col04">{{cart.goods.gunit}}</li>
            <li class="col05">{{cart.goods.gprice}}元</li>
            <li class="col06">
                <div class="num_add">
                    <a href="javascript:;" class="minus fl">-</a>   
                    <input type="text" class="num_show fl" value="{{cart.count}}">
                    <a href="javascript:;" class="add fl">+</a>
                </div>
            </li>
            <li class="col07"></li>
            <li class="col08"><a href="javascript:cart_del({{cart.id}});">删除</a></li>
        </ul>
        {% endfor %}
        

        <ul class="settlements">
            <li class="col01"><input type="checkbox" id="check_all"></li>
            <li class="col02">全选</li>
            <li class="col03">合计(不含运费)：<span>¥</span><em id="total"></em><br>共计<b id="totalcount"></b>件商品</li>
            <li class="col04"><input class="order" name="" type="submit" value="去结算"/></li>
        </ul>
        
    </form>
{%endblock body%}
